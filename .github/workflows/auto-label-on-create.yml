name: Auto Label New Issues

on:
  issues:
    types: [opened,edited]

jobs:
  auto-label:
    runs-on: ubuntu-latest

    steps:
      - name: Auto-assign label based on title or body
        env:
          GH_TOKEN: ${{ secrets.GH_PROJECTS_PAT }}
        run: |
            echo "üîç Starting Auto-Label Script"

            # Validate required inputs
            if [[ -z "${{ github.event.issue.number }}" || -z "${{ github.event.issue.title }}" ]]; then
            echo "‚ùå Missing issue number or title. Exiting."
            exit 1
            fi

            ISSUE_NUMBER=${{ github.event.issue.number }}
            ISSUE_TITLE="${{ github.event.issue.title }}"
            REPO="${{ github.repository }}"
            GH_TOKEN=${{ secrets.GH_PROJECTS_PAT }}

            echo "‚ÑπÔ∏è Issue number: $ISSUE_NUMBER"
            echo "‚ÑπÔ∏è Repository: $REPO"
            echo "üìù Original Title: $ISSUE_TITLE"

            # Lowercase everything for simpler matching
            TEXT=$(echo "$ISSUE_TITLE" | tr '[:upper:]' '[:lower:]')
            echo "üîé Matching tags in: '$TEXT'"

            # Determine the label
            if echo "$TEXT" | grep -Eq '\[feature\]'; then
            LABEL="feature"
            echo "‚úÖ Matched [feature] tag."
            elif echo "$TEXT" | grep -Eq '\[bug\]'; then
            LABEL="bug"
            echo "‚úÖ Matched [bug] tag."
            elif echo "$TEXT" | grep -Eq '\[refactoring\]'; then
            LABEL="refactor"
            echo "‚úÖ Matched [refactoring] tag."
            else
            echo "‚ö†Ô∏è No matching label tag found in title. Skipping label assignment."
            exit 0
            fi

            echo "üè∑Ô∏è Label to apply: $LABEL"
            echo "üöÄ Sending label to GitHub..."

            # Apply the label
            RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" -X POST \
            -H "Authorization: token $GH_TOKEN" \
            -H "Content-Type: application/json" \
            -d "[\"$LABEL\"]" \
            "https://api.github.com/repos/$REPO/issues/$ISSUE_NUMBER/labels")

            if [[ "$RESPONSE" == "200" || "$RESPONSE" == "201" ]]; then
            echo "‚úÖ Label applied successfully."
            else
            echo "‚ùå Failed to apply label. HTTP status code: $RESPONSE"
            exit 1
            fi
