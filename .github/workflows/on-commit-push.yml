name: Auto Manage Commit Labels

on:
  push:
    branches:
      - '**'

jobs:
  manage-commit:
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v3

      - name: Set up Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Fetch Project, Field, and Status IDs
        env:
          GH_TOKEN: ${{ secrets.GH_PROJECTS_PAT }}
        run: |
          echo "üì¶ Fetching Project and Status field information..."

          PROJECT_RESPONSE=$(curl -s -X POST -H "Authorization: bearer $GH_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"query":"query { user(login: \"onlyHydra\") { projectsV2(first: 100) { nodes { id title } } } }"}' \
            https://api.github.com/graphql)

          PROJECT_ID=$(echo "$PROJECT_RESPONSE" | jq -r '.data.user.projectsV2.nodes[] | select(.title == "@onlyHydra'\''s Minishell Kanban") | .id')
          if [ -z "$PROJECT_ID" ] || [ "$PROJECT_ID" == "null" ]; then
            echo "‚ùå Failed to fetch PROJECT_ID."
            exit 1
          fi
          echo "‚úÖ Fetched PROJECT_ID: $PROJECT_ID"

          FIELD_RESPONSE=$(curl -s -X POST -H "Authorization: bearer $GH_TOKEN" -H "Content-Type: application/json" \
            -d "{\"query\": \"query { node(id: \\\"$PROJECT_ID\\\") { ... on ProjectV2 { fields(first: 100) { nodes { ... on ProjectV2SingleSelectField { id name } } } } } }\"}" \
            https://api.github.com/graphql)

          IN_PROGRESS_ID=$(echo "$FIELD_RESPONSE" | jq -r '.data.node.fields.nodes[] | select(.name == "Status") | .id')
          if [ -z "$IN_PROGRESS_ID" ] || [ "$IN_PROGRESS_ID" == "null" ]; then
            echo "‚ùå Failed to fetch Status field ID."
            exit 1
          fi

          STATUS_RESPONSE=$(curl -s -X POST -H "Authorization: bearer $GH_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{\"query\": \"query { node(id: \\\"$IN_PROGRESS_ID\\\") { ... on ProjectV2SingleSelectField { options { id name } } } }\"}" \
            https://api.github.com/graphql)

          IN_PROGRESS_OPTION_ID=$(echo "$STATUS_RESPONSE" | jq -r '.data.node.options[] | select(.name == "In progress") | .id')
          IN_REVIEW_OPTION_ID=$(echo "$STATUS_RESPONSE" | jq -r '.data.node.options[] | select(.name == "In review") | .id')

          if [ -z "$IN_PROGRESS_OPTION_ID" ] || [ "$IN_PROGRESS_OPTION_ID" == "null" ]; then
            echo "‚ùå Failed to fetch IN_PROGRESS_OPTION_ID."
            exit 1
          fi

          if [ -z "$IN_REVIEW_OPTION_ID" ] || [ "$IN_REVIEW_OPTION_ID" == "null" ]; then
            echo "‚ùå Failed to fetch IN_REVIEW_OPTION_ID."
            exit 1
          fi

          echo "‚úÖ All required IDs fetched successfully."

          echo "PROJECT_ID=$PROJECT_ID" >> $GITHUB_ENV
          echo "IN_PROGRESS_ID=$IN_PROGRESS_ID" >> $GITHUB_ENV
          echo "IN_PROGRESS_OPTION_ID=$IN_PROGRESS_OPTION_ID" >> $GITHUB_ENV
          echo "IN_REVIEW_OPTION_ID=$IN_REVIEW_OPTION_ID" >> $GITHUB_ENV

      - name: Handle Commit Actions
        env:
          GH_TOKEN: ${{ secrets.GH_PROJECTS_PAT }}
        run: |
          echo "üîç Getting latest commit info..."
          COMMIT_MSG=$(git log -1 --pretty=%B)
          COMMIT_AUTHOR=$(git log -1 --pretty='%ae')
          COMMIT_SHA=$(git rev-parse HEAD)

          echo "üìù Commit message: $COMMIT_MSG"
          echo "üôç Commit author: $COMMIT_AUTHOR"

          AUTHOR_LOGIN=$(curl -s -H "Authorization: token $GH_TOKEN" \
            "https://api.github.com/repos/${{ github.repository }}/commits/$COMMIT_SHA" \
            | jq -r '.author.login')

          ISSUE_NUMBER=$(echo "$COMMIT_MSG" | grep -oP "#\d+" | grep -oP "\d+" | head -n 1)
          if [ -z "$ISSUE_NUMBER" ]; then
            echo "‚ùå No issue number found in commit message. Skipping..."
            exit 0
          fi
          echo "‚úÖ Found ISSUE_NUMBER: $ISSUE_NUMBER"

          ISSUE_DATA=$(curl -s -H "Authorization: token $GH_TOKEN" \
            "https://api.github.com/repos/${{ github.repository }}/issues/$ISSUE_NUMBER")

          ASSIGNEE_LOGIN=$(echo "$ISSUE_DATA" | jq -r '.assignee.login')
          echo "üéØ Assigned to: $ASSIGNEE_LOGIN"

          if [[ "$AUTHOR_LOGIN" == "$ASSIGNEE_LOGIN" ]]; then
            echo "üöÄ First commit detected by assignee!"

            echo "üóÇ Updating labels..."
            curl -s -X DELETE -H "Authorization: token $GH_TOKEN" \
              "https://api.github.com/repos/${{ github.repository }}/issues/$ISSUE_NUMBER/labels/ready"

            curl -s -X POST -H "Authorization: token $GH_TOKEN" \
              -d "[\"in progress\"]" \
              "https://api.github.com/repos/${{ github.repository }}/issues/$ISSUE_NUMBER/labels"

            echo "üîÅ Updating project status to 'In Progress'..."
            ITEM_QUERY=$(curl -s -X POST -H "Authorization: bearer $GH_TOKEN" \
              -H "Content-Type: application/json" \
              -d "{\"query\": \"query { node(id: \\\"$PROJECT_ID\\\") { ... on ProjectV2 { items(first: 100) { nodes { id content { ... on Issue { id number } } } } } }\"}" \
              https://api.github.com/graphql)

            ITEM_ID=$(echo "$ITEM_QUERY" | jq -r ".data.node.items.nodes[] | select(.content.number == $ISSUE_NUMBER) | .id")

            UPDATE_STATUS=$(curl -s -X POST -H "Authorization: bearer $GH_TOKEN" \
              -H "Content-Type: application/json" \
              -d "{\"query\":\"mutation { updateProjectV2ItemFieldValue(input: {projectId: \\\"$PROJECT_ID\\\", itemId: \\\"$ITEM_ID\\\", fieldId: \\\"$IN_PROGRESS_ID\\\", value: { singleSelectOptionId: \\\"$IN_PROGRESS_OPTION_ID\\\" }}) { projectV2Item { id } } }\"}" \
              https://api.github.com/graphql)

            echo "üîÅ Project update response: $UPDATE_STATUS"
          else
            echo "üëÄ Commit not made by assignee. No action taken."
          fi
